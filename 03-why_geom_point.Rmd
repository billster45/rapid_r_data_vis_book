# Why start with geom_point() ?

## ggplot is famed for annoying errors

* It's a good idea to start with ggplot2::geom_point() because it works for for both raw and summarised data straight away. This both speeds up everyone's EDA and makes ggplot less intimidating for beginners. It is famed for easily triggering errors that can confuse you. So much so that one of the maintainers of ggplot asked people on [Twitter](https://twitter.com/thomasp85/status/1170998101101953025?s=12) what their most common ggplot error was.

* To show you some classic errors let's explore more granular data where each row describes a person getting married. We just do a little data cleaning on the marriage date a column on whether they were married before.

```{r prep_case_data}
marriage <-
  mosaicData::Marriage %>%
  tidylog::mutate(prev_marriage = as.character(prevconc)) %>%
  tidylog::mutate(prev_marriage = case_when(
    is.na(prev_marriage) ~ "First Time",
    TRUE ~ prev_marriage
  )) %>%
  tidylog::mutate(ceremonydate1 = lubridate::parse_date_time(ceremonydate, "mdy"))

kableExtra::kable(utils::head(marriage %>% 
                                dplyr::select(ceremonydate1, person, prev_marriage, age, race, sign)))
```

* In our previous data set we had one value per city and date so geom_line worked fine as long as the date and the city were in the "aesthetics" of the plot (e.g. x,y, colour, category, or facet being the most common). 

* A common way to trigger ggplot2 errors or create confusing plots is using bar or line charts before the data is summarised.

* For example, a line chart is inappropriate with many ages per previous marriage status.

```{r plot_error, error = TRUE}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age
  ) +
  ggplot2::geom_line()
```

* And here using a bar chart instead returns an error.

```{r, error = TRUE}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age
  ) +
  ggplot2::geom_bar()
```

* ggplot2::geom_col() or ggplot2::geom_bar(stat = "identity") will plot the data for us but it's showing the sum of all the ages in each group which doesn't really mean much.

```{r}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age
  ) +
  ggplot2::geom_bar(stat = "identity")
  #ggplot2::geom_col()
```

* A column may end up being the final plot choice, but for fast EDA let's avoid bars, lines and columns and retreat to our friend geom_point()

* Another reason to avoid bars to begin with is they do a statistical transformation without us realising it. This is well explained in the [Statistical Transformatoins](https://r4ds.had.co.nz/data-visualisation.html#statistical-transformations) chapter of [R for Data Science](https://r4ds.had.co.nz/)

## Retreat to geom_point() 

* Here we go back to using ggplot2::geom_point() and facet by person

```{r}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age
  ) +
  ggplot2::facet_wrap(~person) +
  ggplot2::geom_point(alpha = 0.3)
```

* Immediately this is interesting as we see the ages of brides and grooms and what if they are getting married for the first time or if they are divorced or widowed. 

* We can then experiment with different ways of showing these distributions. Hadley Wickham's [ggplot2: Elegant Graphics for Data Analysis](https://ggplot2-book.org/) has a good short chapter on [displaying distributions](https://ggplot2-book.org/statistical-summaries.html#distributions) 

* First let's try a histogram.

```{r plot_error_fix}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = age) +
  ggplot2::facet_wrap(~ person + 
                        prev_marriage) +
  ggplot2::geom_histogram()
```

* We get a warning. We can set the bin width by hand, say 6 bins.

```{r}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(x = age) +
  ggplot2::facet_wrap(~ person + 
                        prev_marriage) +
  ggplot2::geom_histogram(bins = "6")
```

* This looks better but is there an optimum bin number? There is probably no "optimum" as this [exchange](https://stats.stackexchange.com/questions/798/calculating-optimal-number-of-bins-in-a-histogram) discusses.

* Or we might try the density distribution with ggplot2::geom_density()

```{r plot_error_fix2}
p <-
  marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = age,
    fill = prev_marriage
  ) +
  ggplot2::geom_density(adjust = 1, 
                        alpha = 0.5, 
                        colour = NA) +
  ggplot2::facet_wrap(vars(person), 
                      ncol = 1) +
  ggplot2::theme_minimal()

directlabels::direct.label(p, list("top.points", cex = .75, hjust = 0, vjust = -0.2))
```

## geom_jitter() **and** geom_boxplot() is better

* But with so few data points ggplot2::box_plot() with the data points overlaid with ggplot2::geom_jitter() works well.

```{r}
marriage %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age
  ) +
  ggplot2::facet_wrap(~person) +
  ggplot2::geom_boxplot(alpha = 0.8) +
  ggplot2::geom_jitter(width = 0.1,
                       alpha = 0.3) +
  ggplot2::theme_light()
```

## Final choice: geom_jitter() **and** stat_summary()

* Until recently the chart above would have been my final plot. Until I saw the fantastic ["evolution of a ggplot"](https://cedricscherer.netlify.com/2019/05/17/the-evolution-of-a-ggplot-ep.-1/) post. 

* In the gif below you can see they also start with a boxplot but the final choices is ggplot2::geom_jitter() and ggplot2::stat_summary(). The post gives the full code in a gradual story like the ggplot flip books. 

```{r, echo=FALSE, out.width = "100%"}
knitr::include_graphics(path = "https://d33wubrfki0l68.cloudfront.net/1e7033393a2c70dc1255c5d0f1c563e945519251/61035/img/evol-ggplot/evol-ggplot-1.gif") 
```

* And here is the final plot.

```{r, echo=FALSE, out.width = "100%"}
knitr::include_graphics(path = "https://d33wubrfki0l68.cloudfront.net/ca54e2775766e840243d03d86f0bdc1b7aa2291a/93cec/post/2019-05-17_evol-ggplot-1_files/figure-html/plot-with.map-1.png") 
```

* Inspired by that plot and its code this final plot is much more engaging  than the boxplot because it tells a story far more clearly with no explanation needed. Much like a chart in an online newspaper.

```{r, echo=FALSE, fig.height=10}
knitr::include_graphics(path = "marriage.svg") 
```

```{r}
p <- marriage %>% 
  dplyr::group_by(person,prev_marriage) %>% 
  dplyr::mutate(pers_prev_avg = median(age)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(person) %>% 
  dplyr::mutate(pers_avg = median(age)) %>% 
  dplyr::ungroup() %>% 
  ggplot2::ggplot() +
  ggplot2::aes(
    x = prev_marriage,
    y = age,
    colour = prev_marriage
  ) +
  ggplot2::facet_wrap(~person, ncol = 1) +
  ggplot2::stat_summary(fun.y = median, 
                        geom = "point", 
                        size = 4,
                        alpha = 0.8) +
  ggplot2::stat_summary(aes(label= paste( round(..y..,1), 
                                          " years")),
                        fun.y=median, 
                        colour = "black",
                        geom="text", 
                        size=3,
                        vjust = -1.5) +
  ggplot2::geom_hline(aes(yintercept = pers_avg), 
                     color = "gray70", 
                     size = 0.6) +
  ggplot2::geom_text(aes(x = 0.7,
                         y = pers_avg,
                         label = paste(person," average age", round(pers_avg,0)), 
                         #colour = "white",
                         hjust = 1.05),
                     colour = "black",
                     size = 3) +
  ggplot2::geom_segment(aes(x = prev_marriage, 
                   xend = prev_marriage,
                   y = pers_avg, 
                   yend = pers_prev_avg),
               size = 0.8) +
  ggplot2::geom_jitter(size = 2, 
                       alpha = 0.4, 
                       width = 0.2) +
  ggplot2::scale_color_brewer(type = "qual",
                              palette = "Dark2") +
  ggplot2::theme_minimal()+
  ggplot2::theme(
                 plot.title = element_text(size = 14, 
                                           hjust = 0),
                 legend.position = "none",
                 axis.title.x = element_blank(),
                 axis.title.y = element_blank(),
                 panel.grid = element_blank(),
                 strip.text.x = element_text(size = 12,
                                             hjust = 0.1),
                 panel.border = element_rect(colour = "black", 
                                             fill=NA,
                                             size = 0.1)
                 ) +
  ggplot2::scale_y_continuous(breaks=base::seq(0,100,10)) +
  ggplot2::coord_flip() +
    ggplot2::labs(
    title = "Average* age of brides and grooms by previous marriage status",
    caption = "*The average is the median. This is the middle age among all ages when sorted in order so that 50% of ages fall below that value and 50% above it"
  ) 

ggplot2::ggsave(file="marriage.svg", 
                device = "svg",
                plot=p)
```

* In the plot above we can see grooms are older on average overall. But do they tend to be older or younger than their bride within each marriage? 

* As a final quick exploratory chart we put the ceremondy ID on the x axi, use geom_point() for age and colour the dots for brides and grooms with their own colour. As we have added the ceremeony ID (bookpageID) to the group aesthetic, when we add geom_line this creates a line that joins the two data points for each marriage.

* we can see that more often than not grooms are older than brides.

```{r}
marriage %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = bookpageID, 
               y = age, 
               colour = person, 
               group = bookpageID) + 
  ggplot2::geom_point() + 
  ggplot2::geom_line() + 
    ggplot2::coord_flip()
```

