# Setup {#intro}

## Navigating an R markdown 

* A quick way to move around an R Markdown document in RStudio is through the document outline. You can see the outline by holding down Ctrl+Shift+O, clicking the top right icon in the code pane, or left clicking on the bottom bar of the R markdown file. The gif below shows you how it works.

```{r, echo=FALSE, out.width = "80%"}
knitr::include_graphics("outline.gif") 
```
</br>
* Recorded with ScreenToGif: https://www.screentogif.com/

## Libraries

Here are all the R packages that are used in this guide. 

```{r libraries, warning=FALSE}
# data vis https://www.htmlwidgets.org/index.html
library(ggplot2) # static charts - amazing variety
library(plotly) # interactive charts
library(apexcharter) # much like the paid for highchater js library. Powerful
library(rayshader) # 3D charts
library(trelliscopejs) #  small multiples
library(dygraphs) # awesome interactive timeseries

# ggplot extensions https://www.ggplot2-exts.org/gallery/
library(scales) # improve your scales
library(gganimate) # animate your ggplot
library(png) # dunno
library(directlabels) # for directly labelling lines for example
library(gghighlight) # label points of interest on your charts
library(ggrepel) # move labels so they don't overlap

# colours
library(RColorBrewer) # ready to use colour pallets

# tables
library(kableExtra) # attractive static tables
library(formattable) # colour tables. Like Excel's conditional formattinng
library(rpivotTable) # like Excel's pivot table
library(DT) # awesome interactive tables

# Quality Assurance
library(tidylog) # great for QA on the fly 

# wrangling / munging / manipulating
library(tidyverse) # loads of useful packages in one 
library(glue) # not sure

# time series tools
library(anytime) # convert text into the right date type
library(xts) # convert to time series for dygraphs
library(tsbox) # easily convert to time series

# sample data
library(mosaicData) # sample data

library(xfun)
# https://github.com/vincentarelbundock/Rdatasets/blob/master/Rdatasets.R
# https://vincentarelbundock.github.io/Rdatasets/
```

## The data to visualise

* A lot of data visilisation is showing how values change over time. Therefore, rather than the ususal iris or mtcars, this guide uses a built-in data set within ggplot of housing sales in American cities over several years.

* The only manipulation we will do is to create a real date using the excellet R lubrdate package. We also reduce the number of American cities so our first charts aren't too crowded.

* In this simple data preperation or wrangling I'll use tidylog with dplyr. It's a simple way to do fast basic Quality Asssurance as you code. 

* Simple replace dplyr verbs with the same verb in tidylog. This will tell you key info about what is being done to your data by each dplyr verb. For example, how many rows are dropped or added byfilters or joins, and what percentage of values changed after a mutate.

```{r create_df, message=TRUE}
# create a data frame with a real date for plotting
df <- ggplot2::txhousing %>% 
  tidylog::mutate(date = lubridate::make_date(year = year,
                                              month = month, 
                                              day =1)) 

# reduce the number of cities for simpler plots
df_red <- df %>% 
  dplyr::group_by(city) %>% 
  tidylog::mutate(sales_max = base::max(sales)) %>% 
  dplyr::ungroup() %>% 
  tidylog::filter(sales_max >= 800)
```

* Look at these useful messages above crated by tiylog. So it tells us what percentage of values are NA. And how many rows the filter has removed.

* Has this worked? No! The mutate has gone wrong as we would like 100% of rows to have the maximum sales value! Well spotted tidylog. We correct it below by removing the NAs from the maximum

```{r}
# reduce the number of cities for simpler plots
df_red <- df %>% 
  dplyr::group_by(city) %>% 
  tidylog::mutate(sales_max = base::max(sales, 
                                        na.rm = TRUE)) %>% 
  dplyr::ungroup() %>% 
  tidylog::filter(sales_max >= 800)
```

Let's take a quick look at the top few rows of the data using kableExtra table.

```{r}
kableExtra::kable(utils::head(df))
```

## Code style 

### Include the package name every time. Why?

* When I first started learning R I tried to teach myself with other people's code. I got confused where functions came from, particularly when they used their own functions. It made their code appear harder, more complex and cleverer than it really was. 

* Instead I use the package name before every function. Even base R functions. This can help people new to R who read your code. And it can help you when yourself when you come back to code you did ages ago and have forgotten what you were doing. 

* Another good reason to use the package name is you can hit the tab key at the end of the double colon like this and see all the functions in that package.

* Also, try highlighting a function, including the package name and hit the F1 key. (You'll see David Robinson do this a lot even on his own packages.) Also try hitting the F2 key to quickly see all the possible parameters in a function and see what the defaults are that it will use if you don't set them to a new value. 

```{r package_name, eval=FALSE}
ggplot2::
dplyr::arrange()
ggrepel::geom_text_repel()
```

```{r, echo=FALSE, out.width = "1100%"}
knitr::include_graphics("package_name.gif") 
```

### One line does one thing (Hit the return key a lot!)

* Try and get each line to do one thing by hitting the return key after every pipe, comma or plus symbol in ggplot. 

* Also, provide values for your paramenters in the order the function expects them so you don't have to name them. I think it's better to name each one so your code is easier to read.

* Here is code that works but doesn't follow any of those rules. The code is cramped and slow to understand, edit or re-use.

```{r cramped_code, eval=FALSE}
ggplot(df) +
  geom_line(aes(date, sales, colour = city)) +
  ggplot2::theme_minimal() +
  gghighlight(max(sales) > 5000, label_params = list(size = 4)) +
  scale_y_continuous(labels = scales::comma) +
  scale_x_date(date_breaks = "1 year", labels = scales::date_format("%d %b %y"), limits = c(as.Date("2000-01-01"), as.Date("2015-07-01"))) +
  labs(title = "US Housing Sales over time", subtitle = "US cities with more than 5k sales in a month", caption = "Source: ggplot2 package demo data") +
  geom_vline(xintercept = years, linetype = 4) +
  theme(panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), strip.text.x = element_text(size = 10), axis.text.x = element_text(angle = 60, hjust = 1, size = 9), legend.text = element_text(size = 12), legend.position = "right", legend.direction = "vertical", plot.title = element_text(size = 22, face = "bold"), plot.subtitle = element_text(color = "grey", size = 18), plot.caption = element_text(hjust = 0, size = 12, color = "darkgrey"), legend.title = element_blank())
```

* The code below is the same code as above but it follows all these rules:

1. Use package names
2. Each line does one thing or is one paramater settging in a function
3. Tabbed consistently by hitting the return key after each pipe, comma or plus
3. Put spaces around equals 
4. Name every parameter you put in a function

By following these rules it means:

1. The code is easier to run top downwards adding one chunk at a time (like the popular ggplot flipbooks I describe at bullet 11 here: https://github.com/billster45/r-guides-and-galleries/blob/master/README.md#learn-to-visualise-data-with-r)
2. Easily comment whole lines or parameters to undersatnd what they add.
3. More easily find and edit parameaters (e.g. a font size)
4. Helps others QA or re-use your code more quickly.
5. Helps others new to R understand what you are doing.

```{r clean_code, eval=FALSE}
df %>%
  ggplot2::ggplot() +
  ggplot2::aes(
    x = date,
    y = sales,
    colour = city
  ) +
  ggplot2::geom_line() +
  ggplot2::theme_minimal() +
  gghighlight::gghighlight(max(sales) > 5000,
                           label_params = list(size = 4)
  ) +
  ggplot2::scale_y_continuous(labels = scales::comma) +
  ggplot2::scale_x_date(
    date_breaks = "1 year",
    labels = scales::date_format("%d %b %y"),
    limits = c(
      as.Date("2000-01-01"),
      as.Date("2015-07-01")
    )
  ) +
  ggplot2::labs(
    title = "US Housing Sales over time",
    subtitle = "US cities with more than 5k sales in a month",
    caption = "Source: ggplot2 package demo data"
  ) +
  ggplot2::geom_vline(
    xintercept = years,
    linetype = 4
  ) +
  ggplot2::theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.text.x = element_text(size = 10),
    axis.text.x = element_text(
      angle = 60,
      hjust = 1,
      size = 9
    ),
    legend.text = element_text(size = 12),
    legend.position = "right",
    legend.direction = "vertical",
    plot.title = element_text(
      size = 22,
      face = "bold"
    ),
    plot.subtitle = element_text(
      color = "grey",
      size = 18
    ),
    plot.caption = element_text(
      hjust = 0,
      size = 12,
      color = "darkgrey"
    ),
    legend.title = element_blank()
  )
```