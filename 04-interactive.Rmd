# Interactive plots

## Plotly cheat: convert ggplot with plotly::ggplotly()

* Interactive plots help you and your audience find stories in data faster and more enjoyably. Carson Sievert (who maintains the Plotly R package) showed in a [talk](https://talks.cpsievert.me/20180202/#1) how interactive plots can "augment" your data exploration but only if we an "iterate quickly". And this is possible with how easy and tolerant plotly is to use.

* However, while plotly is fast to explore, adding the final polish can be harder than ggplot.

* Sievert also uses the same 

* A quick way to use Plotly that builds on your ggplot skills is to put it through a plotly function called plotly::ggplotly() like this...

```{r ggplotly, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

plotly::ggplotly(p)
```

## Edit ggplot conversion with plotly::plotly_build()

* Often, even with editing how the original ggplot looks, the plotly::ggplotly() function doesn't quite convert to what you wnat. If this happens use plotly::plotly_build() instead to build a plotly plot where you can edit all the settings.

* plotly::plotly_build() creates a nested list of all the settings you can explore in RStudio using the viewer. Here is how we create a plotly_build().

```{r plotly_build, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

p_build <- plotly::plotly_build(p)
```

* And now we later any of the setgins in p_build like this. Here we have edited the font size on the x axis to be a very small size 8.

```{r}
p_build[["x"]][["layout"]][["xaxis"]][["tickfont"]][["size"]] = 8

p_build
```

* But of course that code above is very fiddly to work out. The gif below shows you how to browse the nested structure with the viewer and then automatically geneate the code you need to edit each value.

```{r, echo=FALSE, out.width = "1100%"}
knitr::include_graphics(path = "plotly_build.gif") 
```

## Plotly most basic

* Plotly is very forgiving. Here we don't tell it what kind of plot we want (such as points or lines) but it still creates a plot. And thanfully it's our friend data points..

```{r plotly_basic, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city)
```

## plotly (a few more settings)

* with a few more settings we can make it a line plot
https://plot.ly/r/line-and-scatter/

```{r plotly_further, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## plotly (bells & whistles)

* And as before add some bells and whistles to get close to our final plot.

```{r plotly_bells_whistles, warning=FALSE,message=FALSE}
ax <- list(
  title = "",
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = FALSE,
  showgrid = FALSE
)

df_red %>% 
  plotly::plot_ly(x = ~date, 
                  y = ~sales, 
                  text = rownames(df_red)) %>%
  add_lines(color = ~city, 
            colorscale = "set3") %>%
  rangeslider() %>%
  plotly::layout(xaxis = ax, yaxis = ax)
```

* Here are some good further plotly resources
https://plotly-r.com/index.html
https://moderndata.plot.ly/tufte-style-visualizations-in-r-using-plotly/
https://plotly-r.com/

## apexchater simple

* The [highcharter](https://github.com/jbkunst/highcharter) package creates interactive charts to the quality you often see on newspaper websites. It can produce great data visualisaiotns like these [poll tracking charts](https://www.politico.eu/europe-poll-of-polls/united-kingdom/). However, it's not free to use.

* ApexCharter is almost as good, is inspried by highcharter, and is free to use. Look how easily we can create a chart with it just using this code.

```{r apex_simple, out.width = "1100%"}
df_red %>% 
  apexcharter::apex(type = "line",
                  mapping = aes(x = date,
                                y = sales,
                                group = city
                                ))
```

## apexchater with bells & whistles

* To add the bells and whistles the [apexcharter reference](https://dreamrs.github.io/apexcharter/reference/index.html) is very well laid out with good examples. Here I've put in some useful ones in a clear code format. 

```{r apex_bells_whistles, out.width = "1100%"}
df_red %>% 
  apexcharter::apex(aes(x = date, 
                        y = sales, 
                        group = city), 
           type = "line") %>% 
  apexcharter::ax_legend(position = "right") %>% 
  apexcharter::ax_stroke(width = 2) %>% 
  #apexcharter::ax_colors(mypalette) %>%
  apexcharter::ax_yaxis(
    title = list(text = "Sales")
  ) %>% 
  apexcharter::ax_xaxis(labels = list(format = "yyyy")) %>% 
  apexcharter::ax_labs(
    title = "apexcharter chart for sales by City",
    subtitle = "this is a subtitle"
  ) %>% 
  apexcharter::ax_title(
    style = list(fontSize = "22px")
  ) %>% 
  apexcharter::ax_subtitle(
    style = list(fontSize = "16px", 
                 color = "#BDBDBD")
  ) %>% 
  apexcharter::ax_chart(zoom = list(
    enabled = TRUE, type = "xy"
  )) 
```

## dygraphs for time series data

* Similar in style to apexchater is the excellent dygraphs for when your data is a time series...

* One hurdle is your data frame needs to be a time series. A really easy way to convert is the tsbox pacakge
http://rstudio.github.io/dygraphs/
https://www.tsbox.help/articles/tsbox.html

```{r dygraphss}
df_red_ts <- df_red %>% 
  dplyr::select(date,city,sales) %>% 
  tsbox::ts_xts()

df_red_ts %>% 
  dygraphs::dygraph()
```

## dygraphs bells & whistles

* Again, here is a bells & whilstles version you can play around with to get it how you like.

* The help pages for dygraphs are very well laid out. Pretty much you only need this one guide to find out how to change all the settings possible: https://rstudio.github.io/dygraphs/


```{r dygraphs_bells}
dateWindow <- c("2014-01-01", "2015-07-01")

presAnnotation <- function(dygraph, x, text) {
  dygraph %>%
    dyAnnotation(x, text, width = 60)
}

presBankHolidays <- function(dygraph) {
  dygraph %>%
    dyEvent("2014-07-03", "Independence Day", labelLoc = "bottom") %>%
    dyEvent("2014-11-26", "Thanksgiving", labelLoc = "bottom")
}


df_red_ts %>%
  dygraphs::dygraph(main = "Housing Sales USA") %>%
  # https://github.com/rstudio/dygraphs/issues/80
  dyAxis(
    "y",
    label = "Sales",
    # http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
    valueFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFontSize = 10,
    axisLabelWidth = 70
  ) %>%
  dyRangeSelector(
    height = 60,
    dateWindow = dateWindow
  ) %>%
  dyShading(
    from = "2014-1-1",
    to = "2014-12-31"
  ) %>%
  presBankHolidays() %>%
  dyLegend(width = 600) %>%
  presAnnotation("2014-07-01", text = "2014") %>%
  presAnnotation("2015-06-01", text = "2015") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Set2")) %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyLegend(
    show = "always",
    hideOnMouseOut = FALSE
  )
```

