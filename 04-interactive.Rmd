# Interactive plots

## Plotly cheat: convert ggplot with plotly::ggplotly()

* Interactive plots can help both you and your audience find and tell stories in data faster and more enjoyably. 

* Carson Sievert maintains the Plotly R package. He [describes](https://talks.cpsievert.me/20180202/#1) how interactive plots can "augment" your data exploration but only if we can "iterate quickly". With plotly you can sometimes move faster than ggplot with fewer errors.

* A quick way to use Plotly is to and put a ggplot you have already built through a plotly function called `plotly::ggplotly()`, like this below.

```{r ggplotly, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

plotly::ggplotly(p)
```

## Edit ggplot conversion with plotly::plotly_build()

* Often, even when you have played around with how the original ggplot looks, the `plotly::ggplotly()` function doesn't quite convert to the plot you want. If that happens try using `plotly::plotly_build()` instead of `plotly::ggplotly()`. This gives you more control over the conversion from ggplot to plotly.

* Plotly build is a nested R object which [plotly.js](https://plotly-r.com/overview.html#intro-plotly-js) uses to create the web graphic. This diagram from [chapter 2](https://plotly-r.com/overview.html#intro-plotly-js) of Carson Sievert's [Interactive web-based data visualization with R, plotly, and shiny](https://plotly-r.com/introduction.htmlbook) explains that relationship.

```{r, echo=FALSE, out.width = "100%"}
knitr::include_graphics(path = "https://plotly-r.com/images/printing.svg") 
```

* `plotly::plotly_build()` is a nested object of all the settings used to create the plotly plot that we can now edit.

```{r plotly_build, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

p_build <- plotly::plotly_build(p)

p_build
```

* We can alter any of the settings in `p_build` we have created above. One way to find the setting we want to edit is to use `utils::str()` to browse all the settings as a large nested tree. This function compactly displays the structure of any R object. We run it on `p_build` below.

<details><summary>Show full structure of p_build</summary>
<p>
```{r}
utils::str(p_build)
```
</p>
</details>
<br/>

* In the code below we set the font size of the x axis to be font size of 42. We found this setting by browsing the object structure of `p_build` with `utils::str()` above. 

* Then to create the code that alters the value we have found with `str()` put a `$` at the end of `p_build` in the console and hit the tab key. This shows all the named elements of the first nested level. We can then work our way down the nested levels by adding dollar signs at each level and hitting tab till we find the setting we want at the bottom of the tree.

```{r}
p_build$x$layout$xaxis$tickfont$size = 42

p_build
```

* You can see the code above has changed the font size to the massive 42 in the chart above.

* However, this dollar and tab key method to search through the named elements of the nested plotly object is fiddly and time consuming. The gif below shows an easier point and click method. Unfortunately this only works in recent versions of RStudio. You may have to use the dollar method only. 

* To do this, in the Environment pane click on the magnifying glass to the right of p_build. You can then expand the nested lists as a tree and browse to find the value to change. To the right of each value at the bottom of the tree is an icon. Clicking on the icon automatically generates the code you need to alter that value. Below is an example generated by that method.

> `p_build[["x"]][["layout"]][["xaxis"]][["tickfont"]][["size"]]`

* And here is how we would edit that code to change the font size to 42.

> `p_build[["x"]][["layout"]][["xaxis"]][["tickfont"]][["size"]] = 42`

```{r, echo=FALSE, out.width = "1100%"}
knitr::include_graphics(path = "plotly_build.gif") 
```

## Plotly basic

* Sometimes even passing a ggplot object through `plotly::plotly_build()` does not give us what we want (or it's too time consuming to edit it) so using plotly itself is a better option. 

* Plotly is very forgiving. Below we don't tell plotly what kind of chart we want (such as points or lines) but it still creates a plot. And plotly picks our friend from ggplot a data points plot. Plotly also generates lots of suggestions about what we might add to improve the plot.

```{r plotly_basic, warning=FALSE,message=TRUE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city)
```

## plotly (a few more settings)

* With a few more settings we can turn it into a plotly [line plot](https://plot.ly/r/line-and-scatter/).

```{r plotly_further, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## plotly (bells & whistles)

* Two more bells and whistles we can add are specifying the colour of the lines and an interactive range slider on the x axis.

```{r plotly_bells_whistles, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date, 
                  y = ~sales, 
                  text = rownames(df_red)) %>%
  add_lines(color = ~city, 
            colorscale = "set3") %>%
  rangeslider() 
```

* Carson Sievert has created lots of "bells and whistles" plotly plots on the same Texas housing data in his [Plotly book](https://plotly-r.com/client-side-linking.html). And a few more creative plots [here](https://plotly-r.com/the-data-plot-pipeline.html) on the Texas data.

* Below we re-produce some of Sievert's plots after re-formatting his code according to our three [Code style] rules described earlier. This makes his examples easier to understand and re-use.

* In this plot try clicking on one of the lines to highlight it against all the other lines.

```{r}
# declare `city` as the SQL 'query by' column
tx <- 
  plotly::highlight_key(data = df, 
                        key = ~city)

# initiate a plotly object
base <- 
  plotly::plot_ly(data = tx, 
                  color = I("black")) %>%
  dplyr::group_by(city)

# create a time series of median house price
base %>%
  dplyr::group_by(city) %>%
  plotly::add_lines(x = ~date, y = ~median)
```

* In this plot we can look at cities in isolation and also highlighted against all others. 

```{r}
# generally speaking, use a "unique" key for filter, 
# especially when you have multiple filters!
tx <- plotly::highlight_key(df)

gg <- tx %>% 
  ggplot2::ggplot() + 
  ggplot2::aes(x = date, 
               y = median, 
               group = city) +
  ggplot2::geom_line()

filter <- 
  crosstalk::bscols(
    crosstalk::filter_select("id", "Select a city", tx, ~city),
    plotly::ggplotly(gg, 
                     dynamicTicks = TRUE),
    widths = c(12, 12)
)

tx2 <- plotly::highlight_key(data = df, 
                             key = ~city, 
                             "Select a city")

gg <- tx2 %>% 
  ggplot2::ggplot() + 
  ggplot2::aes(x = date, 
               y = median, 
               group = city) +
  ggplot2::geom_line()

select <- 
  plotly::highlight(
    plotly::ggplotly(gg, 
                     tooltip = "city"), 
    selectize = TRUE, 
    persistent = TRUE
)

crosstalk::bscols(filter, 
                  select)
```

* Here Carson adds lots more interactivity you can play with.

```{r}
tx <- plotly::highlight_key(df)

widgets <- 
  crosstalk::bscols(
  widths = c(12, 12, 12),
  crosstalk::filter_select(id = "city", 
                           label = "Cities", 
                           sharedData = tx, 
                           group = ~city),
  crosstalk::filter_slider(id = "sales", 
                           label = "Sales", 
                           sharedData = tx, 
                           column = ~sales),
  crosstalk::filter_checkbox(id = "year", 
                             label = "Years", 
                             sharedData = tx, 
                             group = ~year, 
                             inline = TRUE)
)

crosstalk::bscols(
  widths = c(4, 8), 
  widgets, 
  plotly::plot_ly(data = tx, 
                  x = ~date, 
                  y = ~median, 
                  showlegend = FALSE) %>% 
    plotly::add_lines(color = ~city, 
                      colors = "black")
)
```

## crosstalk

Finally, here is a more basic use of crosstalk with plotly that you may find easier to re-use as a code template for your own data.

```{r crosstalk, message=FALSE, warning=FALSE}
df_crosstalk <- crosstalk::SharedData$new(data = df, 
                                          key = ~year)

crosstalk::filter_select(
  id = "year",
  label = "Select a year",
  allLevels = TRUE,
  multiple = FALSE,
  sharedData = df_crosstalk,
  group = ~ factor(year)
)

df_crosstalk %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## apexchater basic

* The [highcharter](https://github.com/jbkunst/highcharter) package creates interactive charts to the quality you often see on newspaper websites. It can produce great data visualisations like these [poll tracking charts](https://www.politico.eu/europe-poll-of-polls/united-kingdom/). However, highcharter not free to use.

* ApexCharter is almost as good. It's inspired by highcharter and it is free to use. Look how easily we can create a chart with this simple code.

```{r apex_simple, fig.height=20}
df_red %>% 
  apexcharter::apex(type = "line",
                  mapping = aes(x = date,
                                y = sales,
                                group = city
                                ))
```

## apexchater (bells & whistles)

* To add bells and whistles the [apexcharter reference](https://dreamrs.github.io/apexcharter/reference/index.html) is well laid out with good examples. Here I've put in some useful settings in a clear code format for you to re-use. 

```{r apex_bells_whistles, fig.height=20}
df_red %>% 
  apexcharter::apex(aes(x = date, 
                        y = sales, 
                        group = city), 
           type = "line") %>% 
  apexcharter::ax_legend(position = "right") %>% 
  apexcharter::ax_stroke(width = 2) %>% 
  apexcharter::ax_yaxis(title = list(text = "Sales")) %>% 
  apexcharter::ax_xaxis(labels = list(format = "yyyy")) %>% 
  apexcharter::ax_labs(title = "apexcharter chart for sales by City",
                       subtitle = "this is a subtitle") %>% 
  apexcharter::ax_title(style = list(fontSize = "22px")) %>% 
  apexcharter::ax_subtitle(style = list(fontSize = "16px", 
                                        color = "#BDBDBD")) %>% 
  apexcharter::ax_chart(zoom = list(enabled = TRUE, 
                                    type = "xy")) 
```

## dygraphs basic

* [Dygraphs](http://rstudio.github.io/dygraphs/) are another great choice for time series data but they need the dataframe to be a time series object. One quick way to convert a data frame to a time series is the [tsbox package](https://www.tsbox.help/articles/tsbox.html).

```{r dygraphss, message=FALSE,warning=FALSE}
df_red_ts <- df_red %>% 
  dplyr::select(date,city,sales) %>% 
  tsbox::ts_xts()

df_red_ts %>% 
  dygraphs::dygraph()
```

## dygraphs (bells & whistles)

* Here is a bells & whistles version you can play around with as a template for your own data.

* The help pages for dygraphs are well laid out. You really only need this one [guide](https://rstudio.github.io/dygraphs/) to find out how to change all the dygraph settings. 

```{r dygraphs_bells}
dateWindow <- c("2014-01-01", "2015-07-01")

presAnnotation <- function(dygraph, x, text) {
  dygraph %>%
    dyAnnotation(x, text, width = 60)
}

presBankHolidays <- function(dygraph) {
  dygraph %>%
    dyEvent("2014-07-03", "Independence Day", labelLoc = "bottom") %>%
    dyEvent("2014-11-26", "Thanksgiving", labelLoc = "bottom")
}

df_red_ts %>%
  dygraphs::dygraph(main = "Housing Sales USA") %>%
  # https://github.com/rstudio/dygraphs/issues/80
  dyAxis(
    "y",
    label = "Sales",
    # http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
    valueFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFontSize = 10,
    axisLabelWidth = 70
  ) %>%
  dyRangeSelector(
    height = 60,
    dateWindow = dateWindow
  ) %>%
  dyShading(
    from = "2014-1-1",
    to = "2014-12-31"
  ) %>%
  presBankHolidays() %>%
  dyLegend(width = 600) %>%
  presAnnotation("2014-07-01", text = "2014") %>%
  presAnnotation("2015-06-01", text = "2015") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Set2")) %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyLegend(
    show = "always",
    hideOnMouseOut = FALSE
  )
```