# Interactive plots

## Plotly cheat: convert ggplot with plotly::ggplotly()

* Interactive plots can help both you and your audience find or tell stories in data faster and more enjoyably. 

* Carson Sievert (who maintains the Plotly R package) [described](https://talks.cpsievert.me/20180202/#1) how interactive plots can "augment" your data exploration but only if we an "iterate quickly". with plotly you can sometimes move faster than ggplot with fewer errors.

* A quick way to use Plotly builds on your ggplot skills. Put a ggplot through a plotly function called plotly::ggplotly() like this...

```{r ggplotly, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

plotly::ggplotly(p)
```

## Edit ggplot conversion with plotly::plotly_build()

* Often, even when you have played around with how the original ggplot looks, the plotly::ggplotly() function doesn't quite convert to the plot you want. 

* You can use plotly::plotly_build() instead of plotly::ggplotly() that gives you more control over the conversion.

* Plotly build is a nested R list which [plotly.js](https://plotly-r.com/overview.html#intro-plotly-js) uses to create the web graphic. This diagram from [chapter 2](https://plotly-r.com/overview.html#intro-plotly-js) of Caron's Sievert's [Interactive web-based data visualization with R, plotly, and shiny](https://plotly-r.com/introduction.htmlbook) explains that relationship.

```{r, echo=FALSE, out.width = "100%"}
knitr::include_graphics(path = "https://plotly-r.com/images/printing.svg") 
```

* plotly::plotly_build() is a nested list of all the settings. First, here is how we create a plotly_build() object we can edit.

```{r plotly_build, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

p_build <- plotly::plotly_build(p)

p_build
```

* We can alter any of the settings in p_build by using utils::str(). The str function compactly displays the structure of any R object. 

<details><summary>Show full structure of p_build</summary>
<p>
```{r}
utils::str(p_build)
```
</p>
</details>
<br/>

* In the code below we set the font size of the x axis to be a huge font size of 42. 

* We found this setting by browsing the object structure of p_buid. We do this by putting a dollar at the end of **p_build** in the console then hit the tab key. This shows the named elements of the first nested level. We can then work our way down the nested levels by adding dollar signs and hitting tab till we find the setting we want.

```{r}
p_build$x$layout$xaxis$tickfont$size = 42

p_build
```

* You can see the code above has changed the font size to the massive 42 in the chart above.

* However, this dollar and tab key method to search through the named elements of the neseted plotly object is fiddly and time consuming. The gif below shows you an easier point and click way to do it (but only in recent versions of RStudio). In the environment pane click on the magnifying glass to the right of p_build. You can then expand the nested lists as a tree and browse to find the value to change. To the right of each value is an icon. Clicking on it automatically generates the code you need to alter that value. Below is an example.

> p_build[["x"]][["layout"]][["xaxis"]][["tickfont"]][["size"]]

```{r, echo=FALSE, out.width = "1100%"}
knitr::include_graphics(path = "plotly_build.gif") 
```

## Plotly most basic

* Sometimes passing a ggplot through ggplotly does not give us what we want. So using plotly itself is a better option. 

* Plotly is very forgiving. Below we don't tell plotly what kind of chart we want (such as points or lines) but it still creates a plot. It's our friend from ggplot, data points. It also generates lots of suggestions about what we might add.

```{r plotly_basic, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city)
```

## plotly (a few more settings)

* Sith a few more settings we can turn it inot a [line plot](https://plot.ly/r/line-and-scatter/).


```{r plotly_further, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## plotly (bells & whistles)

* Two more bells and whistles we can add are speciying the colour and a range slider.

```{r plotly_bells_whistles, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date, 
                  y = ~sales, 
                  text = rownames(df_red)) %>%
  add_lines(color = ~city, 
            colorscale = "set3") %>%
  rangeslider() 
```

* Also, Carson Sievert has created lots of bells and whistles plots on the same Texas housing data in his [Plotly book](https://plotly-r.com/client-side-linking.html). And more [here](https://plotly-r.com/the-data-plot-pipeline.html)

* Below we re-produce some of Sievert's plots after re-formatting the code according to our [Code style] rules described earlier. This makes the examples easier to understand and re-use.

* Try clicking on one of the lines to highlight it in this plot.

```{r}
# declare `city` as the SQL 'query by' column
tx <- 
  plotly::highlight_key(data = df, 
                        key = ~city)

# initiate a plotly object
base <- 
  plotly::plot_ly(data = tx, 
                  color = I("black")) %>%
  dplyr::group_by(city)

# create a time series of median house price
base %>%
  dplyr::group_by(city) %>%
  plotly::add_lines(x = ~date, y = ~median)
```

* In this plot we can look at cities in isloation or highlighged against all others. 

```{r}
# generally speaking, use a "unique" key for filter, 
# especially when you have multiple filters!
tx <- plotly::highlight_key(df)

gg <- tx %>% 
  ggplot2::ggplot() + 
  ggplot2::aes(x = date, 
               y = median, 
               group = city) +
  ggplot2::geom_line()

filter <- 
  crosstalk::bscols(
    crosstalk::filter_select("id", "Select a city", tx, ~city),
    plotly::ggplotly(gg, 
                     dynamicTicks = TRUE),
    widths = c(12, 12)
)

tx2 <- plotly::highlight_key(data = df, 
                             key = ~city, 
                             "Select a city")

gg <- tx2 %>% 
  ggplot2::ggplot() + 
  ggplot2::aes(x = date, 
               y = median, 
               group = city) +
  ggplot2::geom_line()

select <- 
  plotly::highlight(
    plotly::ggplotly(gg, 
                     tooltip = "city"), 
    selectize = TRUE, 
    persistent = TRUE
)

crosstalk::bscols(filter, 
                  select)
```

* Here Carson adds lots more interactivity.

```{r}
tx <- plotly::highlight_key(df)

widgets <- 
  crosstalk::bscols(
  widths = c(12, 12, 12),
  crosstalk::filter_select(id = "city", 
                           label = "Cities", 
                           sharedData = tx, 
                           group = ~city),
  crosstalk::filter_slider(id = "sales", 
                           label = "Sales", 
                           sharedData = tx, 
                           column = ~sales),
  crosstalk::filter_checkbox(id = "year", 
                             label = "Years", 
                             sharedData = tx, 
                             group = ~year, 
                             inline = TRUE)
)

crosstalk::bscols(
  widths = c(4, 8), 
  widgets, 
  plotly::plot_ly(data = tx, 
                  x = ~date, 
                  y = ~median, 
                  showlegend = FALSE) %>% 
    plotly::add_lines(color = ~city, 
                      colors = "black")
)
```

## crosstalk

Finally, here is a more basic use of crosstalk with plotly that you may find easier to re-use as a code tempate.

```{r crosstalk}
df_crosstalk <- crosstalk::SharedData$new(data = df, 
                                          key = ~year)

crosstalk::filter_select(
  id = "year",
  label = "Select a year",
  allLevels = TRUE,
  multiple = FALSE,
  sharedData = df_crosstalk,
  group = ~ factor(year)
)

df_crosstalk %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## apexchater simple

* The [highcharter](https://github.com/jbkunst/highcharter) package creates interactive charts to the quality you often see on newspaper websites. It can produce great data visualisaiotns like these [poll tracking charts](https://www.politico.eu/europe-poll-of-polls/united-kingdom/). However, it's not free to use.

* ApexCharter is almost as good. It's inspried by highcharter but is free to use. Look how easily we can create a chart with this simple code.

```{r apex_simple, fig.height=20}
df_red %>% 
  apexcharter::apex(type = "line",
                  mapping = aes(x = date,
                                y = sales,
                                group = city
                                ))
```

## apexchater with bells & whistles

* To add the bells and whistles the [apexcharter reference](https://dreamrs.github.io/apexcharter/reference/index.html) is very well laid out with good examples. Here I've put in some useful ones in a clear code format. 

```{r apex_bells_whistles, fig.height=20}
df_red %>% 
  apexcharter::apex(aes(x = date, 
                        y = sales, 
                        group = city), 
           type = "line") %>% 
  apexcharter::ax_legend(position = "right") %>% 
  apexcharter::ax_stroke(width = 2) %>% 
  apexcharter::ax_yaxis(
    title = list(text = "Sales")
  ) %>% 
  apexcharter::ax_xaxis(labels = list(format = "yyyy")) %>% 
  apexcharter::ax_labs(
    title = "apexcharter chart for sales by City",
    subtitle = "this is a subtitle"
  ) %>% 
  apexcharter::ax_title(
    style = list(fontSize = "22px")
  ) %>% 
  apexcharter::ax_subtitle(
    style = list(fontSize = "16px", 
                 color = "#BDBDBD")
  ) %>% 
  apexcharter::ax_chart(zoom = list(
    enabled = TRUE, type = "xy"
  )) 
```

## dygraphs for time series data

* [Dygraphs](http://rstudio.github.io/dygraphs/) are excellent for data frames that are in a time series format.

* One quick way to convert a data frame to the time series dygraphs needs is the [tsbox package](https://www.tsbox.help/articles/tsbox.html).

```{r dygraphss}
df_red_ts <- df_red %>% 
  dplyr::select(date,city,sales) %>% 
  tsbox::ts_xts()

df_red_ts %>% 
  dygraphs::dygraph()
```

## dygraphs bells & whistles

* Here is a bells & whilstles version you can play around with as a template for your data.

* The help pages for dygraphs are very well laid out. You really only need this one guide to find out how to change all the settings possible: https://rstudio.github.io/dygraphs/

```{r dygraphs_bells}
dateWindow <- c("2014-01-01", "2015-07-01")

presAnnotation <- function(dygraph, x, text) {
  dygraph %>%
    dyAnnotation(x, text, width = 60)
}

presBankHolidays <- function(dygraph) {
  dygraph %>%
    dyEvent("2014-07-03", "Independence Day", labelLoc = "bottom") %>%
    dyEvent("2014-11-26", "Thanksgiving", labelLoc = "bottom")
}

df_red_ts %>%
  dygraphs::dygraph(main = "Housing Sales USA") %>%
  # https://github.com/rstudio/dygraphs/issues/80
  dyAxis(
    "y",
    label = "Sales",
    # http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
    valueFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFontSize = 10,
    axisLabelWidth = 70
  ) %>%
  dyRangeSelector(
    height = 60,
    dateWindow = dateWindow
  ) %>%
  dyShading(
    from = "2014-1-1",
    to = "2014-12-31"
  ) %>%
  presBankHolidays() %>%
  dyLegend(width = 600) %>%
  presAnnotation("2014-07-01", text = "2014") %>%
  presAnnotation("2015-06-01", text = "2015") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Set2")) %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyLegend(
    show = "always",
    hideOnMouseOut = FALSE
  )
```