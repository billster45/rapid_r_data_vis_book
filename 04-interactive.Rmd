# Interactive plots

## Plotly cheat: convert ggplot with plotly::ggplotly()

* Interactive plots can help both you and your audience find or tell stories in data faster and more enjoyably. 

* Carson Sievert (who maintains the Plotly R package) [described](https://talks.cpsievert.me/20180202/#1) how interactive plots can "augment" your data exploration but only if we an "iterate quickly". And this really is possible with plotly that can be eaier to use than ggplot with fewer errors. However, while plotly is fast to explore, adding the final polish can be harder than ggplot.

* A quick way to use Plotly is to builds on your ggplot skills and put a ggplot through a plotly function called plotly::ggplotly() like this...

```{r ggplotly, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

plotly::ggplotly(p)
```

## Edit ggplot conversion with plotly::plotly_build()

* Often, even with editing how the original ggplot looks, the plotly::ggplotly() function doesn't quite convert to what you wnat. If this happens using plotly::plotly_build() instead to build your plotly can let you edit many of the plotly plot settings

* Plotly build is an R list which [plotly.js](https://plotly-r.com/overview.html#intro-plotly-js) uses to create the web graphic. This diagram from [chapter 2](https://plotly-r.com/overview.html#intro-plotly-js) of Caron's Sievert's [Interactive web-based data visualization with R, plotly, and shiny](https://plotly-r.com/introduction.htmlbook) explains that relationship.

```{r, echo=FALSE, out.width = "100%"}
knitr::include_graphics(path = "https://plotly-r.com/images/printing.svg") 
```

* plotly::plotly_build() is a nested list of all the settings. First, here is how we create a plotly_build() object we can edit.

```{r plotly_build, warning=FALSE,message=FALSE}
p <- df_red %>% 
  ggplot2::ggplot() +
  ggplot2::aes(x = date,
               y = sales,
               colour = city) +
  ggplot2::geom_line() 

p_build <- plotly::plotly_build(p)

p_build

str(p_build)
```

* We can alter any of the settings in p_build by using utils::str(). This compactly displays the structure of any R object. 
```{r}
utils::str(p_build)
```

* In the code below we set the font size on the x axis to be a huge font size of 42. 

* We found this setting by browsing the object structure above, then putting a dollar at the end of p_build and hitting the tab key to see the named elents of this list at different levels. This show us the top level of the list. We can then work our way down with dollars till we find the setting we want.

```{r}
p_build$x$layout$xaxis$tickfont$size = 42

p_build
```

* You can see the font size has changed to the massive 42 above.

* However, this dollar and tab key method to search through the named elemnets of the plotly object is very fiddly and time consuming. The gif below shows you an easier point and click way to do it (but only in recent versions of RStudio).

* To do this, in the environment pane, click on the magnifying glass to the right of p_build. You can then expand the nested lists like a tree till you reach the value to change. To the right of the value you will find an icon to click that automatically generates the code below. It can be used in place of the dollar and tab code method above.

> p_build[["x"]][["layout"]][["xaxis"]][["tickfont"]][["size"]]

```{r, echo=FALSE, out.width = "1100%"}
knitr::include_graphics(path = "plotly_build.gif") 
```

## Plotly most basic

* Often though passing ggplot through plotly does not give us what we want and using plotly itself is a better option. 

* Plotly is very forgiving. Here we don't even tell plotly what kind of chart we want (such as points or lines). But it still creates a plot. And thanfully it's our friend from ggplot, data points. ANd it gives us lots of suggestions about what we might add inthe warnings.

```{r plotly_basic, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city)
```

## plotly (a few more settings)

* with a few more settings we can make it a [line plot](https://plot.ly/r/line-and-scatter/).


```{r plotly_further, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date,
                  y = ~sales,
                  color = ~city,
                  type = 'scatter', 
                  mode = 'lines')
```

## plotly (bells & whistles)

* And as before add some bells and whistles to get close to a final plot.

```{r plotly_bells_whistles, warning=FALSE,message=FALSE}
df_red %>% 
  plotly::plot_ly(x = ~date, 
                  y = ~sales, 
                  text = rownames(df_red)) %>%
  add_lines(color = ~city, 
            colorscale = "set3") %>%
  rangeslider() 
```

* And carson actually goes to town on this exact data set https://plotly-r.com/the-data-plot-pipeline.html


* And more here https://plotly-r.com/client-side-linking.html

```{r}
# load the `txhousing` dataset
data(txhousing, package = "ggplot2")

# declare `city` as the SQL 'query by' column
tx <- highlight_key(txhousing, ~city)

# initiate a plotly object
base <- plot_ly(tx, color = I("black")) %>% 
  group_by(city)

# create a time series of median house price
base %>%
  group_by(city) %>%
  add_lines(x = ~date, y = ~median)
```


```{r}
library(crosstalk)

# generally speaking, use a "unique" key for filter, 
# especially when you have multiple filters!
tx <- highlight_key(txhousing)
gg <- ggplot(tx) + geom_line(aes(date, median, group = city))
filter <- bscols(
  filter_select("id", "Select a city", tx, ~city),
  ggplotly(gg, dynamicTicks = TRUE),
  widths = c(12, 12)
)

tx2 <- highlight_key(txhousing, ~city, "Select a city")
gg <- ggplot(tx2) + geom_line(aes(date, median, group = city))
select <- highlight(
  ggplotly(gg, tooltip = "city"), 
  selectize = TRUE, persistent = TRUE
)

bscols(filter, select)
```

```{r}
library(crosstalk)
tx <- highlight_key(txhousing)
widgets <- bscols(
  widths = c(12, 12, 12),
  filter_select("city", "Cities", tx, ~city),
  filter_slider("sales", "Sales", tx, ~sales),
  filter_checkbox("year", "Years", tx, ~year, inline = TRUE)
)
bscols(
  widths = c(4, 8), widgets, 
  plot_ly(tx, x = ~date, y = ~median, showlegend = FALSE) %>% 
    add_lines(color = ~city, colors = "black")
)
```

* Here are some good further plotly resources
https://plotly-r.com/index.html
https://moderndata.plot.ly/tufte-style-visualizations-in-r-using-plotly/
https://plotly-r.com/

## apexchater simple

* The [highcharter](https://github.com/jbkunst/highcharter) package creates interactive charts to the quality you often see on newspaper websites. It can produce great data visualisaiotns like these [poll tracking charts](https://www.politico.eu/europe-poll-of-polls/united-kingdom/). However, it's not free to use.

* ApexCharter is almost as good, is inspried by highcharter, and is free to use. Look how easily we can create a chart with it just using this code.

```{r apex_simple, out.width = "1100%"}
df_red %>% 
  apexcharter::apex(type = "line",
                  mapping = aes(x = date,
                                y = sales,
                                group = city
                                ))
```

## apexchater with bells & whistles

* To add the bells and whistles the [apexcharter reference](https://dreamrs.github.io/apexcharter/reference/index.html) is very well laid out with good examples. Here I've put in some useful ones in a clear code format. 

```{r apex_bells_whistles, out.width = "1100%"}
df_red %>% 
  apexcharter::apex(aes(x = date, 
                        y = sales, 
                        group = city), 
           type = "line") %>% 
  apexcharter::ax_legend(position = "right") %>% 
  apexcharter::ax_stroke(width = 2) %>% 
  #apexcharter::ax_colors(mypalette) %>%
  apexcharter::ax_yaxis(
    title = list(text = "Sales")
  ) %>% 
  apexcharter::ax_xaxis(labels = list(format = "yyyy")) %>% 
  apexcharter::ax_labs(
    title = "apexcharter chart for sales by City",
    subtitle = "this is a subtitle"
  ) %>% 
  apexcharter::ax_title(
    style = list(fontSize = "22px")
  ) %>% 
  apexcharter::ax_subtitle(
    style = list(fontSize = "16px", 
                 color = "#BDBDBD")
  ) %>% 
  apexcharter::ax_chart(zoom = list(
    enabled = TRUE, type = "xy"
  )) 
```

## dygraphs for time series data

* Similar in style to apexchater is the excellent dygraphs for when your data is a time series...

* One hurdle is your data frame needs to be a time series. A really easy way to convert is the tsbox pacakge
http://rstudio.github.io/dygraphs/
https://www.tsbox.help/articles/tsbox.html

```{r dygraphss}
df_red_ts <- df_red %>% 
  dplyr::select(date,city,sales) %>% 
  tsbox::ts_xts()

df_red_ts %>% 
  dygraphs::dygraph()
```

## dygraphs bells & whistles

* Again, here is a bells & whilstles version you can play around with to get it how you like.

* The help pages for dygraphs are very well laid out. Pretty much you only need this one guide to find out how to change all the settings possible: https://rstudio.github.io/dygraphs/


```{r dygraphs_bells}
dateWindow <- c("2014-01-01", "2015-07-01")

presAnnotation <- function(dygraph, x, text) {
  dygraph %>%
    dyAnnotation(x, text, width = 60)
}

presBankHolidays <- function(dygraph) {
  dygraph %>%
    dyEvent("2014-07-03", "Independence Day", labelLoc = "bottom") %>%
    dyEvent("2014-11-26", "Thanksgiving", labelLoc = "bottom")
}


df_red_ts %>%
  dygraphs::dygraph(main = "Housing Sales USA") %>%
  # https://github.com/rstudio/dygraphs/issues/80
  dyAxis(
    "y",
    label = "Sales",
    # http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript
    valueFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFormatter = 'function(d){return d.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ",");}',
    axisLabelFontSize = 10,
    axisLabelWidth = 70
  ) %>%
  dyRangeSelector(
    height = 60,
    dateWindow = dateWindow
  ) %>%
  dyShading(
    from = "2014-1-1",
    to = "2014-12-31"
  ) %>%
  presBankHolidays() %>%
  dyLegend(width = 600) %>%
  presAnnotation("2014-07-01", text = "2014") %>%
  presAnnotation("2015-06-01", text = "2015") %>%
  dyOptions(colors = RColorBrewer::brewer.pal(8, "Set2")) %>%
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyLegend(
    show = "always",
    hideOnMouseOut = FALSE
  )
```

